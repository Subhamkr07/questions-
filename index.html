<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ProQuiz Challenge</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Roboto:wght@400;500;700&family=Orbitron:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif; 
            background: linear-gradient(135deg, #1a202c 0%, #2d3748 100%);
            color: #e2e8f0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            overflow: hidden;
        }

        body.lang-hi {
            font-family: 'Roboto', sans-serif; 
        }

        .quiz-container {
            background-color: rgba(45, 55, 72, 0.85);
            backdrop-filter: blur(10px);
            padding: 20px;
            border-radius: 16px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3), 0 0 0 1px rgba(255,255,255,0.05) inset;
            width: 95%;
            max-width: 700px;
            text-align: center;
            border: 1px solid rgba(74, 85, 104, 0.5);
            position: relative;
            overflow: hidden;
        }

        /* Full screen splash screen specific styles */
        #splash-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #1a202c 0%, #2d3748 100%); /* Match body background */
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            z-index: 100; /* Ensure it's on top */
            color: #90cdf4;
            font-family: 'Orbitron', sans-serif;
            font-size: 2.5rem;
            opacity: 1;
            transition: opacity 3s ease-out; /* Changed to 3s */
        }

        #splash-screen.exiting {
            opacity: 0;
            pointer-events: none; /* Disable interaction during fade out */
        }

        #splash-screen h1 {
            font-size: 2.5rem;
            margin-bottom: 20px;
            animation: pulseText 2s infinite;
        }

        @keyframes pulseText {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.05); opacity: 0.9; }
            100% { transform: scale(1); opacity: 1; }
        }

        @media (min-width: 640px) {
            #splash-screen h1 {
                font-size: 3.5rem;
            }
        }


        .screen {
            display: none;
            animation: fadeIn 0.7s ease-out forwards;
        }

        .screen.active {
            display: block;
        }

        .screen.exiting {
            animation: fadeOut 0.5s ease-in forwards;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes fadeOut {
            from { opacity: 1; transform: translateY(0); }
            to { opacity: 0; transform: translateY(-20px); }
        }
        
        .grid-container { 
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
            gap: 10px;
            margin-top: 20px;
        }

        @media (min-width: 640px) {
            .grid-container {
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); /* Adjusted minmax */
                gap: 12px; /* Adjusted gap */
            }
        }
        
        .action-button { 
            background-color: #4a5568; 
            color: #e2e8f0; 
            border: none;
            padding: 10px 12px; /* Adjusted padding */
            border-radius: 8px;
            font-size: 0.8rem; /* Adjusted font size */
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            font-weight: 600; 
        }
        
        @media (min-width: 640px) {
             .action-button {
                padding: 12px 18px; /* Adjusted padding */
                font-size: 0.9rem; /* Adjusted font size */
             }
        }

        .action-button:hover {
            background-color: #718096; 
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }
        
        .action-button.all-sections, .action-button.language-select {
            background-color: #4c51bf; 
        }
        .action-button.all-sections:hover, .action-button.language-select:hover {
            background-color: #434190; 
        }
        .action-button.all-sections {
             grid-column: 1 / -1; 
        }

        .question-text {
            font-size: 1.1rem;  /* Adjusted */
            margin-bottom: 20px;
            min-height: 60px; 
            color: #cbd5e0; 
            font-weight: 600;
        }
        @media (min-width: 640px) {
            .question-text {
                font-size: 1.3rem; /* Adjusted */
            }
        }

        .options-container {
            display: grid;
            grid-template-columns: 1fr;
            gap: 10px;
            margin-top: 20px;
        }
        @media (min-width: 640px) {
            .options-container {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        .action-button.option { 
            background-color: #2d3748; 
            border: 1px solid #4a5568; 
        }
        .action-button.option:hover {
            background-color: #4a5568; 
        }

        .timer-container {
            margin-bottom: 20px;
            height: 30px;
            position: relative;
        }

        .timer-text {
            font-family: 'Orbitron', sans-serif;
            font-size: 1.5rem; 
            color: #63b3ed; 
            font-weight: 700;
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            z-index: 2;
        }
        
        .timer-bar-background {
            width: 100%;
            height: 10px;
            background-color: #4a5568; 
            border-radius: 5px;
            position: absolute;
            bottom: 0;
            left:0;
        }

        .timer-bar {
            height: 100%;
            background-color: #63b3ed; 
            border-radius: 5px;
            width: 100%;
            transition: width 0.2s linear, background-color 0.5s ease;
        }

        .score-display {
            font-size: 1.25rem; 
            margin: 15px 0; /* Adjusted margin */
            color: #a0aec0; 
        }
        @media (min-width: 640px) {
            .score-display {
                font-size: 1.4rem; /* Adjusted */
            }
        }

        .results-summary {
            font-size: 1.1rem; /* Adjusted */
            margin-bottom: 15px; /* Adjusted margin */
            line-height: 1.6;
        }
        .results-summary span {
            font-weight: bold;
        }
        .results-summary .correct { color: #48bb78; } 
        .results-summary .wrong { color: #f56565; } 

        .control-buttons-container {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 15px; /* Adjusted margin */
            justify-content: center;
        }

        @media (min-width: 640px) {
            .control-buttons-container {
                flex-direction: row;
                gap: 12px; /* Adjusted gap */
            }
        }

        .action-button.next-level { background-color: #38a169; } 
        .action-button.next-level:hover { background-color: #2f855a; } 
        .action-button.retry { background-color: #dd6b20; } 
        .action-button.retry:hover { background-color: #c05621; } 
        .action-button.show-answers, .action-button.home, .action-button.change-lang, .action-button.try-diff-cat { background-color: #718096; } 
        .action-button.show-answers:hover, .action-button.home:hover, .action-button.change-lang:hover, .action-button.try-diff-cat:hover { background-color: #4a5568; } 

        .answers-reveal-container {
            margin-top: 15px; /* Adjusted margin */
            text-align: left;
            max-height: 180px; /* Adjusted max-height */
            overflow-y: auto;
            padding: 10px;
            background-color: rgba(0,0,0,0.2);
            border-radius: 8px;
        }
        .answers-reveal-container p {
            margin-bottom: 8px;
            font-size: 0.875rem; 
        }
        .answers-reveal-container strong {
            color: #63b3ed; 
        }

        h1, h2, h3 { 
            font-family: 'Orbitron', sans-serif;
            color: #90cdf4; 
            margin-bottom: 10px; 
        }
        h1 { font-size: 1.6rem; }  /* Adjusted */
        h2 { font-size: 1.2rem; }  /* Adjusted */
        h3 { font-size: 1rem; margin-top: 12px; } /* Adjusted */
        
        @media (min-width: 640px) {
            h1 { font-size: 2rem; } /* Adjusted */
            h2 { font-size: 1.4rem; } /* Adjusted */
        }

        .action-button.option { 
            opacity: 0;
            transform: translateY(10px);
            animation: optionFadeIn 0.5s ease-out forwards;
        }
        .options-container .action-button.option:nth-child(1) { animation-delay: 0.1s; }
        .options-container .action-button.option:nth-child(2) { animation-delay: 0.2s; }
        .options-container .action-button.option:nth-child(3) { animation-delay: 0.3s; }
        .options-container .action-button.option:nth-child(4) { animation-delay: 0.4s; }
        .options-container .action-button.option:nth-child(5) { animation-delay: 0.5s; } /* For 5th option if any */


        @keyframes optionFadeIn {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .timer-text.low-time {
            animation: pulse 1s infinite;
        }
        @keyframes pulse {
            0% { transform: translate(-50%, -50%) scale(1); }
            50% { transform: translate(-50%, -50%) scale(1.1); }
            100% { transform: translate(-50%, -50%) scale(1); }
        }

        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background-color: #2d3748;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
            text-align: center;
            width: 90%;
            max-width: 450px;
            transform: translateY(-20px);
            opacity: 0;
            transition: transform 0.3s ease, opacity 0.3s ease;
        }

        .modal-overlay.active .modal-content {
            transform: translateY(0);
            opacity: 1;
        }

        .modal-content p {
            font-size: 1.1rem;
            margin-bottom: 25px;
            color: #cbd5e0;
        }

        .modal-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
        }

        .modal-buttons .action-button {
            padding: 10px 20px;
            font-size: 0.95rem;
            min-width: 120px;
        }

        .modal-buttons .action-button.confirm {
            background-color: #e53e3e; /* Red for destructive action */
        }
        .modal-buttons .action-button.confirm:hover {
            background-color: #c53030;
        }

        .modal-buttons .action-button.cancel {
            background-color: #4a5568;
        }
        .modal-buttons .action-button.cancel:hover {
            background-color: #2d3748;
        }

    </style>
</head>
<body>
    <div id="splash-screen" class="active">
        <h1>Shubham Presents ProQuiz Challenge</h1>
    </div>

    <div class="quiz-container">
        <div id="language-screen" class="screen">
            <h1 id="lang-select-title">Select Language / भाषा चुनें</h1>
            <div class="grid-container mt-6">
                <button id="lang-en" class="action-button language-select">English</button>
                <button id="lang-hi" class="action-button language-select">हिन्दी (Hindi)</button>
            </div>
        </div>

        <div id="start-screen" class="screen">
            <h1 id="start-title"></h1>
            <p id="start-subtitle" class="mb-6 text-slate-400"></p>
            <h2 id="category-select-title"></h2>
            <div id="category-selection" class="grid-container">
                </div>
            <button id="all-sections-button" class="action-button all-sections mt-4">
                </button>
            <button id="change-language-button" class="action-button change-lang mt-4">
                </button>
        </div>

        <div id="quiz-screen" class="screen">
            <div id="quiz-header" class="flex justify-between items-center mb-4">
                <p id="current-level-topic" class="text-lg font-semibold text-sky-400"></p>
                <p id="question-counter" class="text-sm text-slate-400"></p>
            </div>
            <div class="timer-container">
                <div class="timer-bar-background">
                    <div id="timer-bar" class="timer-bar"></div>
                </div>
                <div id="timer-text" class="timer-text">25</div>
            </div>
            <div id="question-text" class="question-text">Question placeholder...</div>
            <div id="options-container" class="options-container">
                </div>
             <button id="quit-quiz-button" class="action-button home mt-6">
                </button>
        </div>

        <div id="results-screen" class="screen">
            <h2 id="results-title"></h2>
            <div id="results-summary" class="results-summary">Results summary...</div>
            <div id="score-display" class="score-display">Your Score: 0 / 5</div>
            <div id="level-feedback" class="mb-4 text-lg"></div>
            <div id="category-completion-summary" class="mb-4 text-md text-amber-400" style="display:none;"></div>
            <div id="control-buttons-container" class="control-buttons-container">
                </div>
            <div id="answers-reveal-container" class="answers-reveal-container" style="display: none;">
                <h3 id="correct-answers-title"></h3>
                <div id="correct-answers-list"></div>
            </div>
        </div>
    </div>

    <div id="reset-confirm-modal" class="modal-overlay">
        <div class="modal-content">
            <p id="reset-confirm-message"></p>
            <div class="modal-buttons">
                <button id="reset-confirm-understand" class="action-button confirm"></button>
                <button id="reset-confirm-back" class="action-button cancel"></button>
            </div>
        </div>
    </div>

    <script>
        // --- UI Text Translations ---
        const uiText = {
            en: {
                proQuizChallenge: "ProQuiz Challenge",
                testYourKnowledge: "Test your knowledge across various domains!",
                selectCategory: "Select a Category:",
                allSections: "All Sections Mix",
                changeLanguage: "Change Language",
                level: "Level",
                question: "Question",
                quitToHome: "Quit to Home",
                levelComplete: "Level Complete!",
                categoryComplete: "Category Complete!",
                youAnswered: "You answered",
                correctly: "correctly",
                and: "and",
                incorrectly: "incorrectly.",
                yourScore: "Your Score:",
                excellentPassed: "Excellent! You've passed this level.",
                keepTrying: "Keep trying! You can do better.",
                nextLevel: "Next Level",
                retryLevel: "Retry Level",
                showCorrectAnswers: "See your wrong answers", 
                backToHome: "Back to Home",
                correctAnswersForLevel: "Wrong Answers & Correct Solutions:", 
                noMoreQuestions: "Not enough unique questions for the next level in this category. Please add more questions or try another category.",
                noQuestionsToStart: "Not enough questions to start a level for this category. Please add more questions or select another category.",
                answer: "Answer",
                congratulationsCompletedAllLevels: "Congratulations! You've completed all {MAX_LEVELS} levels for {CATEGORY_NAME}. Total wrong answers in this category run: {WRONG_COUNT}.",
                tryDifferentCategory: "Try a Different Category",
                resetConfirmMessage: "If you choose to view the correct answers, your progress will be reset, and you will need to start again from Level 1.",
                iUnderstand: "I Understand",
                back: "Back",
                yourAnswer: "Your Answer" 
            },
            hi: {
                proQuizChallenge: "प्रोक्विज़ चैलेंज",
                testYourKnowledge: "विभिन्न क्षेत्रों में अपने ज्ञान का परीक्षण करें!",
                selectCategory: "एक श्रेणी चुनें:",
                allSections: "सभी वर्गों का मिश्रण",
                changeLanguage: "भाषा बदलें",
                level: "स्तर",
                question: "प्रश्न",
                quitToHome: "होम पर वापस जाएं",
                levelComplete: "स्तर पूरा हुआ!",
                categoryComplete: "श्रेणी पूरी हुई!",
                youAnswered: "आपने",
                correctly: "सही उत्तर दिए",
                and: "और",
                incorrectly: "गलत।",
                yourScore: "आपका स्कोर:",
                excellentPassed: "बहुत बढ़िया! आपने यह स्तर पार कर लिया है।",
                keepTrying: "कोशिश करते रहें! आप बेहतर कर सकते हैं।",
                nextLevel: "अगला स्तर",
                retryLevel: "पुनः प्रयास करें",
                showCorrectAnswers: "अपने गलत उत्तर देखें", 
                backToHome: "होम पर वापस",
                correctAnswersForLevel: "गलत उत्तर और सही समाधान:", 
                noMoreQuestions: "इस श्रेणी में अगले स्तर के लिए पर्याप्त अद्वितीय प्रश्न नहीं हैं। कृपया अधिक प्रश्न जोड़ें या कोई अन्य श्रेणी आज़माएँ।",
                noQuestionsToStart: "इस श्रेणी के लिए स्तर शुरू करने के लिए पर्याप्त प्रश्न नहीं हैं। कृपया अधिक प्रश्न जोड़ें या कोई अन्य श्रेणी चुनें।",
                answer: "उत्तर",
                congratulationsCompletedAllLevels: "बधाई हो! आपने {CATEGORY_NAME} के सभी {MAX_LEVELS} स्तर पूरे कर लिए हैं। इस श्रेणी में कुल गलत उत्तर: {WRONG_COUNT}।",
                tryDifferentCategory: "दूसरी श्रेणी आज़माएँ",
                resetConfirmMessage: "यदि आप यह देखना चाहते हैं कि आपने कहाँ गलती की और सही उत्तर क्या था, तो फिर आपको शुरुआत (Level 1) से खेल शुरू करना होगा।",
                iUnderstand: "मैं समझता हूँ",
                back: "वापस",
                yourAnswer: "आपका उत्तर" 
            }
        };

        // --- Question Bank (Loaded from JSON) ---
        let loadedQuestions = {}; // This will hold the questions from the selected questions.json file
        let currentQuestionFile = 'questions.json'; // Default to English questions file

        // --- DOM Elements ---
        const splashScreen = document.getElementById('splash-screen'); // New splash screen element
        const languageScreen = document.getElementById('language-screen');
        const startScreen = document.getElementById('start-screen');
        const quizScreen = document.getElementById('quiz-screen');
        const resultsScreen = document.getElementById('results-screen');

        const langEnButton = document.getElementById('lang-en');
        const langHiButton = document.getElementById('lang-hi');
        const changeLanguageButton = document.getElementById('change-language-button');
        
        const categorySelectionContainer = document.getElementById('category-selection');
        const allSectionsButton = document.getElementById('all-sections-button');
        
        const currentLevelTopicDisplay = document.getElementById('current-level-topic');
        const questionCounterDisplay = document.getElementById('question-counter');
        const timerText = document.getElementById('timer-text');
        const timerBar = document.getElementById('timer-bar');
        const questionTextEl = document.getElementById('question-text'); 
        const optionsContainer = document.getElementById('options-container');
        const quitQuizButton = document.getElementById('quit-quiz-button');

        const resultsSummaryEl = document.getElementById('results-summary'); 
        const scoreDisplayEl = document.getElementById('score-display'); 
        const levelFeedbackEl = document.getElementById('level-feedback'); 
        const categoryCompletionSummaryEl = document.getElementById('category-completion-summary');
        const controlButtonsContainer = document.getElementById('control-buttons-container');
        const answersRevealContainer = document.getElementById('answers-reveal-container');
        const correctAnswersList = document.getElementById('correct-answers-list');

        // Modal elements
        const resetConfirmModal = document.getElementById('reset-confirm-modal');
        const resetConfirmMessage = document.getElementById('reset-confirm-message');
        const resetConfirmUnderstandBtn = document.getElementById('reset-confirm-understand');
        const resetConfirmBackBtn = document.getElementById('reset-confirm-back');


        // --- Game State ---
        let currentLanguage = 'en'; 
        let currentCategory = '';
        let currentQuestions = []; // Questions for the current level
        let currentQuestionIndex = 0;
        let score = 0;
        let timerId;
        const INITIAL_TIME_LEFT = 25; 
        let timeLeft = INITIAL_TIME_LEFT;
        
        // Default values for 6-level categories
        let QUESTIONS_PER_LEVEL = 10; 
        let MAX_LEVELS_PER_CATEGORY = 6; 

        let askedQuestionGlobalIndices = new Set(); // Tracks unique questions asked across all levels in a category playthrough
        let questionsForCurrentLevel = []; // Stores questions for the current level to allow retry/review
        let wronglyAnsweredQuestions = []; // Stores questions answered incorrectly in the current level

        let currentLevelNumber = 1;
        let totalWrongAnswersInCategoryPlaythrough = 0;
        let isAllSectionsMixMode = false; // Flag for the new 10-level mode

        // --- Functions ---

        function setLanguage(lang) {
            currentLanguage = lang;
            document.body.className = `lang-${lang}`; 
            // Determine which question file to load based on language
            currentQuestionFile = (lang === 'hi') ? 'question-hindi.json' : 'questions.json';
            
            // Fetch questions and then transition to start screen
            fetch(currentQuestionFile)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok ' + response.statusText);
                    }
                    return response.json();
                })
                .then(data => {
                    loadedQuestions = data;
                    switchScreen('start-screen'); // Transition to start screen after language selection
                    updateUIText(); // Update UI text and populate categories
                })
                .catch(error => {
                    console.error('There was a problem fetching the questions:', error);
                    showInfoMessage(`Failed to load quiz questions from ${currentQuestionFile}. Please ensure the file is in the correct location and format.`);
                    switchScreen('language-screen'); // Stay on language screen if fetch fails
                });
        }

        function updateUIText() {
            const texts = uiText[currentLanguage];
            // The main splash screen title is now fixed in HTML
            document.getElementById('start-title').textContent = texts.proQuizChallenge;
            document.getElementById('start-subtitle').textContent = texts.testYourKnowledge;
            document.getElementById('category-select-title').textContent = texts.selectCategory;
            allSectionsButton.textContent = texts.allSections;
            changeLanguageButton.textContent = texts.changeLanguage;
            quitQuizButton.textContent = texts.quitToHome;
            document.getElementById('results-title').textContent = texts.levelComplete; 
            document.getElementById('correct-answers-title').textContent = texts.correctAnswersForLevel;
            
            // Modal text
            resetConfirmMessage.textContent = texts.resetConfirmMessage;
            resetConfirmUnderstandBtn.textContent = texts.iUnderstand;
            resetConfirmBackBtn.textContent = texts.back;

            populateCategories(); 
        }

        function populateCategories() {
            categorySelectionContainer.innerHTML = ''; 
            // Use loadedQuestions.categories to get categories
            if (loadedQuestions && loadedQuestions.categories) {
                Object.keys(loadedQuestions.categories).forEach(categoryKey => {
                    const button = document.createElement('button');
                    button.textContent = categoryKey; 
                    button.classList.add('action-button');
                    button.addEventListener('click', () => startGame(categoryKey, false)); // Not All Sections Mix
                    categorySelectionContainer.appendChild(button);
                });
            } else {
                console.error("Questions data not loaded or malformed.");
            }
        }

        function switchScreen(activeScreenId) {
            document.querySelectorAll('.screen').forEach(screen => {
                if (screen.id === activeScreenId) {
                    screen.classList.add('active');
                } else if (screen.classList.contains('active')) {
                    screen.classList.add('exiting');
                    setTimeout(() => {
                        screen.classList.remove('active');
                        screen.classList.remove('exiting');
                    }, 500); 
                }
            });
        }
        
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        function getLevelQuestions(categoryKey) {
            let sourceQuestionsPool = [];
            
            if (isAllSectionsMixMode) {
                // Flatten all questions from all categories for 'All Sections Mix'
                for (const cat in loadedQuestions.categories) {
                    loadedQuestions.categories[cat].forEach((levelObj, levelIdx) => {
                        const levelName = `level${levelIdx + 1}`;
                        if (levelObj && levelObj[levelName]) { // Added check for levelObj and levelName
                            levelObj[levelName].forEach((q, index) => {
                                sourceQuestionsPool.push({ ...q, originalCategory: cat, originalIndex: index, originalLevel: levelIdx + 1 });
                            });
                        }
                    });
                }
            } else {
                // For a specific category, get questions for the current level
                const categoryLevels = loadedQuestions.categories[categoryKey];
                if (categoryLevels && currentLevelNumber <= categoryLevels.length) {
                    const levelObj = categoryLevels[currentLevelNumber - 1];
                    const levelName = `level${currentLevelNumber}`;
                    if (levelObj && levelObj[levelName]) {
                        sourceQuestionsPool = levelObj[levelName].map((q, index) => ({ 
                            ...q, 
                            originalCategory: categoryKey, 
                            originalIndex: index, 
                            originalLevel: currentLevelNumber 
                        }));
                    }
                }
            }

            // Filter out questions already asked in this playthrough
            let newQuestions = sourceQuestionsPool.filter(q => {
                const uniqueId = `${q.originalCategory}_${q.originalLevel}_${q.originalIndex}`;
                return !askedQuestionGlobalIndices.has(uniqueId);
            });
            
            shuffleArray(newQuestions);
            
            // Select the required number of questions for the level
            const levelQuestions = newQuestions.slice(0, QUESTIONS_PER_LEVEL);
            
            // Add selected questions to the global asked set
            levelQuestions.forEach(q => {
                 const uniqueId = `${q.originalCategory}_${q.originalLevel}_${q.originalIndex}`;
                 askedQuestionGlobalIndices.add(uniqueId);
            });
            
            if (levelQuestions.length < QUESTIONS_PER_LEVEL && sourceQuestionsPool.length > 0) {
                 console.warn(`Not enough *new* unique questions for ${categoryKey} for this level to make a full set of ${QUESTIONS_PER_LEVEL}. Found ${levelQuestions.length}. Total unique questions might be running low for this category or all questions have been asked.`);
            }
            
            return levelQuestions;
        }

        function startGame(categoryKey, isMixMode, isNextLevel = false) { // Added isNextLevel parameter
            currentCategory = categoryKey;
            isAllSectionsMixMode = isMixMode;

            if (isAllSectionsMixMode) {
                QUESTIONS_PER_LEVEL = 48; // 48 questions for All Sections Mix
                MAX_LEVELS_PER_CATEGORY = 10; // 10 levels for All Sections Mix
            } else {
                QUESTIONS_PER_LEVEL = 10; // 10 questions for regular categories
                MAX_LEVELS_PER_CATEGORY = 6; // 6 levels for regular categories
            }

            // Reset game state for a new game or if coming from "See wrong answers"
            score = 0; 
            currentQuestionIndex = 0;
            wronglyAnsweredQuestions = []; // Clear wrong answers for the new level
            
            // Only reset level and total wrong answers if it's a new game (not continuing to next level)
            if (!isNextLevel) { 
                currentLevelNumber = 1;
                totalWrongAnswersInCategoryPlaythrough = 0;
                askedQuestionGlobalIndices.clear(); // Clear globally asked questions for a fresh start
            }

            currentQuestions = getLevelQuestions(currentCategory);
            questionsForCurrentLevel = [...currentQuestions]; // Store for review/retry

            if (currentQuestions.length < QUESTIONS_PER_LEVEL && currentQuestions.length > 0) {
                 console.warn(`Starting level with fewer than ${QUESTIONS_PER_LEVEL} questions (${currentQuestions.length}) as not enough unique new ones were available.`);
            } else if (currentQuestions.length === 0) {
                // Use a custom modal or message box instead of alert
                showInfoMessage(uiText[currentLanguage].noQuestionsToStart);
                if (isNextLevel) currentLevelNumber--; // If it was a next level attempt, revert level
                switchScreen('start-screen');
                return;
            }
            
            currentLevelTopicDisplay.textContent = `${currentCategory} - ${uiText[currentLanguage].level} ${currentLevelNumber}`;
            categoryCompletionSummaryEl.style.display = 'none'; 
            switchScreen('quiz-screen');
            loadQuestion();
        }

        function loadQuestion() {
            if (currentQuestionIndex < currentQuestions.length && currentQuestions.length > 0) { 
                const questionData = currentQuestions[currentQuestionIndex];
                questionTextEl.textContent = questionData.question; 
                optionsContainer.innerHTML = ''; 
                
                questionTextEl.style.opacity = '0';
                questionTextEl.style.transform = 'translateY(20px)';
                setTimeout(() => {
                    questionTextEl.style.opacity = '1';
                    questionTextEl.style.transform = 'translateY(0px)';
                    questionTextEl.style.transition = 'opacity 0.5s ease, transform 0.5s ease';
                }, 50);

                const shuffledOptions = shuffleArray([...questionData.options]);

                shuffledOptions.forEach((optionText, index) => {
                    const button = document.createElement('button');
                    button.textContent = optionText;
                    button.classList.add('action-button', 'option');
                    button.style.animationDelay = `${index * 0.1}s`; 
                    button.addEventListener('click', () => selectAnswer(optionText));
                    optionsContainer.appendChild(button);
                });

                questionCounterDisplay.textContent = `${uiText[currentLanguage].question} ${currentQuestionIndex + 1} / ${currentQuestions.length}`; 
                startTimer();
            } else {
                endLevel();
            }
        }

        function selectAnswer(selectedOptionText) {
            clearTimeout(timerId); // Clear the current timer when an answer is selected
            const correctAnswerText = currentQuestions[currentQuestionIndex].correctAnswer; 
            if (selectedOptionText === correctAnswerText) {
                score++;
            } else {
                // Store wrong answer for review
                wronglyAnsweredQuestions.push({
                    question: currentQuestions[currentQuestionIndex].question,
                    correctAnswer: correctAnswerText,
                    yourAnswer: selectedOptionText
                });
            }
            currentQuestionIndex++;
            setTimeout(() => {
                 loadQuestion();
            }, 300); 
        }

        function startTimer() {
            // IMPORTANT: Clear any existing timer before starting a new one
            clearTimeout(timerId); 

            timeLeft = INITIAL_TIME_LEFT;
            timerText.textContent = timeLeft;
            timerBar.style.width = '100%';
            timerBar.style.backgroundColor = '#63b3ed'; 
            timerText.classList.remove('low-time');

            timerId = setInterval(() => { 
                timeLeft--;
                timerText.textContent = timeLeft;
                timerBar.style.width = `${(timeLeft / INITIAL_TIME_LEFT) * 100}%`;

                if (timeLeft <= 5) {
                    timerBar.style.backgroundColor = '#f56565'; 
                    timerText.classList.add('low-time');
                } else if (timeLeft <= 10) {
                    timerBar.style.backgroundColor = '#f6e05e'; 
                }

                if (timeLeft <= 0) {
                    clearTimeout(timerId); // Clears the current interval when time runs out
                    // If time runs out, it's considered a wrong answer
                    wronglyAnsweredQuestions.push({
                        question: currentQuestions[currentQuestionIndex].question,
                        correctAnswer: currentQuestions[currentQuestionIndex].correctAnswer,
                        yourAnswer: "Time's Up!" // Indicate no answer was given
                    });
                    currentQuestionIndex++;
                     setTimeout(() => {
                        loadQuestion();
                    }, 300);
                }
            }, 1000);
        }

        function getPassingScore(level, totalQuestions) {
            if (isAllSectionsMixMode) {
                if (level >= 1 && level <= 9) {
                    return 40; // 40 out of 48
                } else if (level === 10) {
                    return 48; // 48 out of 48
                }
            } else { // 6-level category mode
                if (level >= 1 && level <= 4) {
                    return 7; // 7 out of 10
                } else if (level === 5) {
                    return 8; // 8 out of 10
                } else if (level === 6) {
                    return 10; // 10 out of 10 (to complete Level 6, player must get 10 out of 10)
                }
            }
            return 0; // Default or error case
        }

        function endLevel() {
            clearTimeout(timerId);
            switchScreen('results-screen');
            
            const texts = uiText[currentLanguage];
            const correctCount = score;
            const questionsInThisLevel = currentQuestions.length > 0 ? currentQuestions.length : QUESTIONS_PER_LEVEL;
            const wrongCount = questionsInThisLevel - score;

            totalWrongAnswersInCategoryPlaythrough += wrongCount;

            resultsSummaryEl.innerHTML = `${texts.youAnswered} <span class="correct">${correctCount}</span> ${texts.correctly} ${texts.and} <span class="wrong">${wrongCount}</span> ${texts.incorrectly}`;
            scoreDisplayEl.textContent = `${texts.yourScore} ${score} / ${questionsInThisLevel}`;
            
            controlButtonsContainer.innerHTML = ''; 
            answersRevealContainer.style.display = 'none'; 
            correctAnswersList.innerHTML = ''; 
            categoryCompletionSummaryEl.style.display = 'none';

            const requiredScore = getPassingScore(currentLevelNumber, questionsInThisLevel);

            if (score >= requiredScore) { 
                levelFeedbackEl.textContent = texts.excellentPassed;
                levelFeedbackEl.className = 'mb-4 text-lg text-green-400';

                if (currentLevelNumber >= MAX_LEVELS_PER_CATEGORY) {
                    document.getElementById('results-title').textContent = texts.categoryComplete;
                    let summaryMsg = texts.congratulationsCompletedAllLevels;
                    summaryMsg = summaryMsg.replace("{MAX_LEVELS}", MAX_LEVELS_PER_CATEGORY)
                                         .replace("{CATEGORY_NAME}", currentCategory)
                                         .replace("{WRONG_COUNT}", totalWrongAnswersInCategoryPlaythrough);
                    categoryCompletionSummaryEl.textContent = summaryMsg;
                    categoryCompletionSummaryEl.style.display = 'block';
                    levelFeedbackEl.style.display = 'none'; 

                    const tryDifferentButton = document.createElement('button');
                    tryDifferentButton.textContent = texts.tryDifferentCategory;
                    tryDifferentButton.classList.add('action-button', 'try-diff-cat');
                    tryDifferentButton.addEventListener('click', () => {
                        askedQuestionGlobalIndices.clear(); 
                        switchScreen('start-screen');
                    });
                    controlButtonsContainer.appendChild(tryDifferentButton);
                } else {
                    document.getElementById('results-title').textContent = texts.levelComplete;
                    const nextLevelButton = document.createElement('button');
                    nextLevelButton.textContent = `${texts.nextLevel} (${texts.level} ${currentLevelNumber + 1})`;
                    nextLevelButton.classList.add('action-button', 'next-level');
                    nextLevelButton.addEventListener('click', () => {
                        currentLevelNumber++;
                        startGame(currentCategory, isAllSectionsMixMode, true); // Pass true for isNextLevel
                    });
                    controlButtonsContainer.appendChild(nextLevelButton);
                }
            } else { // Failed level
                document.getElementById('results-title').textContent = texts.levelComplete;
                levelFeedbackEl.textContent = texts.keepTrying;
                levelFeedbackEl.className = 'mb-4 text-lg text-yellow-400';
                
                const retryButton = document.createElement('button');
                retryButton.textContent = texts.retryLevel;
                retryButton.classList.add('action-button', 'retry');
                retryButton.addEventListener('click', () => {
                    // For All Sections Mix, always reset to Level 1 on failure
                    if (isAllSectionsMixMode) {
                        currentLevelNumber = 1;
                        totalWrongAnswersInCategoryPlaythrough = 0;
                        askedQuestionGlobalIndices.clear(); // Clear all asked questions for a fresh start
                        startGame(currentCategory, isAllSectionsMixMode); // Start from Level 1
                    } else {
                        // For regular categories, retry the current level
                        questionsForCurrentLevel.forEach(q => {
                            const uniqueId = `${q.originalCategory}_${q.originalLevel}_${q.originalIndex}`;
                            askedQuestionGlobalIndices.delete(uniqueId); // Allow these questions to be re-asked
                        });
                        totalWrongAnswersInCategoryPlaythrough -= wrongCount; 
                        startGame(currentCategory, isAllSectionsMixMode, currentLevelNumber > 1); 
                    }
                });
                controlButtonsContainer.appendChild(retryButton);

                // Show wrong answers button
                const showAnswersButton = document.createElement('button');
                showAnswersButton.textContent = texts.showCorrectAnswers;
                showAnswersButton.classList.add('action-button', 'show-answers');
                showAnswersButton.addEventListener('click', () => {
                    showResetConfirmModal();
                });
                controlButtonsContainer.appendChild(showAnswersButton);
            }

            const homeButton = document.createElement('button');
            homeButton.textContent = texts.backToHome;
            homeButton.classList.add('action-button', 'home');
            homeButton.addEventListener('click', () => {
                askedQuestionGlobalIndices.clear(); 
                switchScreen('start-screen');
            });
            controlButtonsContainer.appendChild(homeButton);
        }

        function displayWrongAnswers() {
            correctAnswersList.innerHTML = ''; 
            if (wronglyAnsweredQuestions.length === 0) {
                correctAnswersList.innerHTML = `<p>${uiText[currentLanguage].correctAnswersForLevel} ${uiText[currentLanguage].youAnswered} all questions correctly!</p>`;
            } else {
                wronglyAnsweredQuestions.forEach(qData => {
                    const p = document.createElement('p');
                    p.innerHTML = `${uiText[currentLanguage].question}: ${qData.question} <br><strong>${uiText[currentLanguage].answer}: ${qData.correctAnswer}</strong>`;
                    if (qData.yourAnswer && qData.yourAnswer !== qData.correctAnswer) {
                        p.innerHTML += `<br><span class="wrong">${uiText[currentLanguage].yourAnswer}: ${qData.yourAnswer}</span>`;
                    }
                    correctAnswersList.appendChild(p);
                });
            }
            answersRevealContainer.style.display = 'block';
        }

        function showResetConfirmModal() {
            resetConfirmModal.classList.add('active');
        }

        function hideResetConfirmModal() {
            resetConfirmModal.classList.remove('active');
        }

        // Helper function for custom info messages (replaces alert)
        function showInfoMessage(message) {
            const infoModalOverlay = document.createElement('div');
            infoModalOverlay.classList.add('modal-overlay', 'active');
            infoModalOverlay.innerHTML = `
                <div class="modal-content">
                    <p>${message}</p>
                    <div class="modal-buttons">
                        <button class="action-button cancel" id="info-modal-ok">OK</button>
                    </div>
                </div>
            `;
            document.body.appendChild(infoModalOverlay);

            document.getElementById('info-modal-ok').addEventListener('click', () => {
                infoModalOverlay.classList.remove('active');
                setTimeout(() => infoModalOverlay.remove(), 300);
            });
        }

        // --- Initial Load of Questions and Splash Screen Transition ---
        function initialLoadAndTransition() {
            // Load default English questions initially
            fetch('questions.json') 
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok ' + response.statusText);
                    }
                    return response.json();
                })
                .then(data => {
                    loadedQuestions = data;
                    // After questions are loaded, transition from splash screen to language screen
                    splashScreen.classList.add('exiting'); // Start fade out animation
                    setTimeout(() => {
                        splashScreen.classList.remove('active');
                        splashScreen.style.display = 'none'; // Hide completely after animation
                        switchScreen('language-screen'); // Show language screen
                        updateUIText(); // Update UI text and populate categories for language screen
                    }, 3000); // Wait for splash screen fade out (3 seconds)
                })
                .catch(error => {
                    console.error('There was a problem fetching the questions:', error);
                    showInfoMessage(`Failed to load initial quiz questions from questions.json. Please ensure the file is in the correct location and format.`);
                    // If questions fail to load, still transition from splash screen
                    splashScreen.classList.add('exiting');
                    setTimeout(() => {
                        splashScreen.classList.remove('active');
                        splashScreen.style.display = 'none';
                        switchScreen('language-screen'); // Show language screen even on error
                        updateUIText();
                    }, 3000); // Wait for splash screen fade out (3 seconds)
                });
        }

        // --- Event Listeners ---
        quitQuizButton.addEventListener('click', () => {
            clearTimeout(timerId);
            askedQuestionGlobalIndices.clear(); 
            switchScreen('start-screen');
        });

        langEnButton.addEventListener('click', () => setLanguage('en'));
        langHiButton.addEventListener('click', () => setLanguage('hi'));
        changeLanguageButton.addEventListener('click', () => {
            clearTimeout(timerId); 
            switchScreen('language-screen');
        });

        allSectionsButton.addEventListener('click', () => startGame("All Sections", true)); // True for All Sections Mix
        
        // Modal button listeners
        resetConfirmUnderstandBtn.addEventListener('click', () => {
            hideResetConfirmModal();
            displayWrongAnswers(); // Show wrong answers first
            // Then reset game state and start a new game from Level 1
            currentLevelNumber = 1;
            totalWrongAnswersInCategoryPlaythrough = 0;
            askedQuestionGlobalIndices.clear(); 
            // Delay starting the game to allow user to see answers briefly if desired, then go to home
            setTimeout(() => {
                switchScreen('start-screen');
            }, 5000); // Show answers for 5 seconds before returning to home
        });

        resetConfirmBackBtn.addEventListener('click', () => {
            hideResetConfirmModal();
            // User chose not to view answers, stay on results screen
        });

        // Initial call to start the game flow (splash screen -> language screen)
        initialLoadAndTransition();
    </script>
</body>
</html>

